# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Cursor Project Rules
# Unity 2022 LTS â€¢ game-ci/unity-builder â€¢ MCP deploy
# Branch Strategy: dev â†’ main with TS-ID feature branches
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rules:
  # 1ï¸âƒ£  ISSUE â†’ BRANCH
  - id: triage-ts
    trigger: issue_opened
    if: "{{ issue.title | regex('^TS-[0-9]+-') }}"
    actions:
      - github.label: ["triaged", "task"]
      - github.create_branch: "{{ issue.title | slug }}"
      - github.comment: "ðŸ”§ Branch **{{ branch }}** created - happy coding!"

  # 2ï¸âƒ£  FIRST PUSH â†’ PR
  - id: auto-pr
    trigger: push
    if: "{{ branch.name | starts_with('TS-') }} && {{ push.commits == 1 }}"
    actions:
      - github.open_pr:
          title: "{{ branch.name }}"
          body: |
            Closes #{{ issue.number }}
            ### Checklist
            - [ ] Game runs (Editor Play-Mode)
            - [ ] EditMode & PlayMode tests green
            - [ ] >60 FPS on reference device
      - github.request_review: ["@dev-lead", "@qa"]

  # 3ï¸âƒ£  CI ON PR UPDATE
  - id: unity-ci
    trigger: pr_opened|pr_synchronized
    actions:
      - github.run_workflow: unity-ci.yml       # GitHub Action (game-ci/unity-builder)

  # 4ï¸âƒ£  MERGE GATE (all checks green)
  - id: merge-gate
    trigger: pr_checks_passed
    if: "{{ pr.title | regex('^TS-[0-9]+-') }}"
    actions:
      - github.merge_pr: { method: squash }
      - github.comment: "âœ… Squash-merged into **dev**"

  # 5ï¸âƒ£  CLOSE LINKED ISSUE & LABEL DONE
  - id: close-issue
    trigger: pr_merged
    if: "{{ pr.body | contains('Closes #') }}"
    actions:
      - github.close_issue: "{{ pr.body | extract('#(\\d+)') }}"
      - github.label:
          issue: "{{ pr.body | extract('#(\\d+)') }}"
          value: ["done"]

  # 6ï¸âƒ£  TAG & RELEASE ON main
  - id: tag-release
    trigger: push
    if: "{{ branch.name == 'main' }}"
    actions:
      - github.create_tag: "v{{ date.today | date_format('%Y.%m.%d') }}-{{ push.short_sha }}"
      - github.release:
          title: "Release {{ tag }}"
          notes: "Automated build (CI)."

  # 7ï¸âƒ£  DEPLOY TO UNITY MCP
  - id: mcp-deploy
    trigger: release_published
    actions:
      - shell: >
          unity-mcp deploy --build 'Builds/Android/{{ tag }}.apk' --track internal 